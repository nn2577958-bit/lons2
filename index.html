<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ® LONS2 ì»¤ë®¤ë‹ˆí‹°</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body{ font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#111; color:white; display:flex; justify-content:center; }
.container{ width:800px; margin:40px auto; padding:20px; background:#1c1c1c; border-radius:12px;}
h1,h2{ margin-bottom:15px; text-align:center; }
input,textarea{ width:100%; padding:10px; margin-bottom:10px; border-radius:6px; border:none; font-size:16px;}
button{ padding:10px 16px; border:none; border-radius:6px; cursor:pointer; background:#28a745; color:white; font-weight:600;}
.notice-item{ background:#222; padding:12px; border-radius:8px; margin-bottom:10px; border-left:4px solid #4CAF50; position: relative;}
.delete-btn{ position:absolute; top:10px; right:10px; background:#ff4444; font-size:12px; padding:4px 6px; border-radius:4px; }
#login-msg{ color:#ff4444; margin-bottom:10px; text-align:center; }
#admin-status{ margin-bottom:15px; transition:0.5s; text-align:center; }
.online { color:#4CAF50; animation: blink 1s infinite; }
.offline { color:#ff4444; animation: blink 1s infinite; }
@keyframes blink { 50% { opacity:0; } }
#login-alert{ color:#ffaa00; margin-bottom:10px; text-align:center; }
#logout-btn{ background:#ff9900; margin-left:10px; }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ® LONS2 ì»¤ë®¤ë‹ˆí‹°</h1>

  <div id="login-section">
    <button id="login-btn"><i class="fab fa-google"></i> êµ¬ê¸€ ë¡œê·¸ì¸</button>
    <button id="logout-btn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="login-msg"></div>
    <div id="admin-status">ğŸ”´ ê´€ë¦¬ì ì˜¤í”„ë¼ì¸</div>
    <div id="login-alert">ë¡œê·¸ì¸ ì´í›„ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
  </div>

  <hr style="margin:20px 0; border-color:#333;">

  <h2>ğŸ“ ì»¤ë®¤ë‹ˆí‹° ê¸€ì“°ê¸°</h2>
  <input type="text" id="author" placeholder="ì‘ì„±ì">
  <input type="text" id="title" placeholder="ì œëª©">
  <textarea id="content" placeholder="ë‚´ìš©" rows="4"></textarea>
  <button id="post-btn" disabled>ê²Œì‹œê¸€ ì‘ì„±</button>

  <h2>ê²Œì‹œê¸€ ëª©ë¡</h2>
  <div id="posts-container"></div>
</div>

<script type="module">
import { auth, db } from './firebase.js';
import { signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { collection, addDoc, query, orderBy, serverTimestamp, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const loginMsg = document.getElementById('login-msg');
const adminStatus = document.getElementById('admin-status');
const postBtn = document.getElementById('post-btn');
const postsContainer = document.getElementById('posts-container');
const loginAlert = document.getElementById('login-alert');

const ADMIN_EMAIL = "nn2577958@gmail.com";
let currentUser = null;

// ë¡œê·¸ì¸
loginBtn.addEventListener('click', async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
    loginMsg.textContent = "ë¡œê·¸ì¸ ì„±ê³µ!";
    currentUser = auth.currentUser;

    // ê´€ë¦¬ìì´ë©´ Firestore ìƒíƒœ ì—…ë°ì´íŠ¸
    if (currentUser.email === ADMIN_EMAIL) {
      await setDoc(doc(db, "status", "admin"), { isOnline: true, lastChanged: serverTimestamp() });
    }
  } catch (err) {
    loginMsg.textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message;
  }
});

// ë¡œê·¸ì•„ì›ƒ
logoutBtn.addEventListener('click', async () => {
  if (currentUser?.email === ADMIN_EMAIL) {
    await setDoc(doc(db, "status", "admin"), { isOnline: false, lastChanged: serverTimestamp() });
  }
  await signOut(auth);
  currentUser = null;
  loginMsg.textContent = "ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ";
});

// ê´€ë¦¬ì ìƒíƒœ í‘œì‹œ + ë²„íŠ¼ ì œì–´
onAuthStateChanged(auth, user => {
  currentUser = user;
  updateAdminUI(user);
});

// ê²Œì‹œê¸€ ì‘ì„±
postBtn.addEventListener('click', async () => {
  if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
    alert("ë¡œê·¸ì¸ í›„ ê´€ë¦¬ìë§Œ ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
    return;
  }

  const author = document.getElementById('author').value.trim();
  const title = document.getElementById('title').value.trim();
  const content = document.getElementById('content').value.trim();
  if (!author || !title || !content) return alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

  await addDoc(collection(db, 'posts'), {
    author, title, content,
    uid: currentUser.uid,
    createdAt: serverTimestamp()
  });

  document.getElementById('author').value = '';
  document.getElementById('title').value = '';
  document.getElementById('content').value = '';
});

// ì‹¤ì‹œê°„ ê²Œì‹œê¸€ êµ¬ë…
const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
onSnapshot(postsQuery, snapshot => {
  postsContainer.innerHTML = '';
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement('div');
    div.className = 'notice-item';
    const time = data.createdAt?.toDate().toLocaleString() || '';
    div.innerHTML = `<strong>${data.title}</strong> <small>by ${data.author} | ${time}</small><div>${data.content}</div>`;

    if (currentUser?.email === ADMIN_EMAIL) {
      const delBtn = document.createElement('button');
      delBtn.textContent = "ì‚­ì œ";
      delBtn.className = "delete-btn";
      delBtn.addEventListener('click', async () => {
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          await deleteDoc(doc(db, 'posts', docSnap.id));
        }
      });
      div.appendChild(delBtn);
    }

    postsContainer.appendChild(div);
  });
});

// ì‹¤ì‹œê°„ ê´€ë¦¬ì ìƒíƒœ êµ¬ë…
onSnapshot(doc(db, "status", "admin"), snapshot => {
  const data = snapshot.data();
  if (data?.isOnline) {
    adminStatus.textContent = "ğŸŸ¢ ê´€ë¦¬ì ì˜¨ë¼ì¸";
    adminStatus.className = "online";
  } else {
    adminStatus.textContent = "ğŸ”´ ê´€ë¦¬ì ì˜¤í”„ë¼ì¸";
    adminStatus.className = "offline";
  }
});

// UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateAdminUI(user) {
  if (user?.email === ADMIN_EMAIL) {
    adminStatus.textContent = "ğŸŸ¢ ê´€ë¦¬ì ì˜¨ë¼ì¸";
    adminStatus.className = "online";
    postBtn.disabled = false;
    loginAlert.style.display = "none";
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  } else {
    postBtn.disabled = true;
    loginAlert.style.display = "block";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
}
</script>
</body>
</html>
